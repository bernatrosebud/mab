<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MAB - Modern Architecture Browser</title>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --black: #0f0f0f;
  --gray-dark: #333;
  --gray-mid: #777;
  --gray-light: #bbb;
  --gray-xlight: #ebebeb;
  --white: #ffffff;
  --border: 1px solid #c8c8c8;
  --font-mono: Arial, sans-serif;
  --header-h: 220px;
}
html { font-size: 15px; }
body { font-family: var(--font-mono); background: #ffffff; color: var(--black); min-height: 100vh; }

/* HEADER FIJO */
#site-header {
  position: fixed; top: 0; left: 0; right: 0;
  z-index: 110; background: #ffffff;
}
#top-bar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 24px 10px;
}
#logo {
  font-family: Helvetica, Arial, sans-serif; font-weight: 300; font-size: 18px; letter-spacing: 0.03em; text-transform: uppercase;
  cursor: pointer; color: #000000; user-select: none;
  display: flex; align-items: center;
}


#top-btns { display: flex; gap: 6px; align-items: center; }
#btn-reset, #share-btn, #btn-intro {
  font-family: var(--font-mono); font-size: 14px;
  border: var(--border); background: transparent;
  color: var(--gray-dark); padding: 3px 8px; cursor: pointer; transition: all .15s;
  line-height: 1; display: flex; align-items: center; justify-content: center;
  width: 32px; height: 32px;
}
#btn-reset:hover, #share-btn:hover, #btn-intro:hover { background: var(--black); color: var(--white); border-color: var(--black); }

/* ESTADO BUTTON — cuadrado 32x32 con símbolo, igual al resto */
#estado-btn-group { position: relative; }
#btn-estado {
  font-family: var(--font-mono); font-size: 15px;
  border: var(--border); background: transparent;
  color: var(--gray-dark); cursor: pointer; transition: all .15s;
  line-height: 1; display: flex; align-items: center; justify-content: center;
  width: 32px; height: 32px; position: relative;
}
#btn-estado:hover { background: var(--black); color: var(--white); border-color: var(--black); }
#btn-estado.has-active::after {
  content: ''; position: absolute; top: 5px; right: 5px;
  width: 6px; height: 6px; border-radius: 50%; background: #FFD600;
}
#fi-estado {
  display: none; position: absolute; top: calc(100% + 4px); right: 0; left: auto;
  /* 4 botones × 32px + 3 gaps × 6px = 146px */
  width: 146px; z-index: 300;
  border: var(--border); background: #ffffff;
  padding: 4px;
}
#fi-estado.open { display: flex; flex-direction: column; gap: 3px; }
#fi-estado .tag { flex: 1 1 100%; width: 100%; justify-content: flex-start; padding: 5px 10px; }

/* FILTROS */
#filters-wrapper { padding: 6px 24px 12px; }
.filter-row {
  display: grid; grid-template-columns: repeat(6, 1fr);
  gap: 6px; margin-bottom: 6px;
}
.filter-row:last-child { margin-bottom: 0; }
.filter-group {
  border: none; background: transparent;
  position: relative;
}
.filter-label {
  display: flex; align-items: center; justify-content: space-between;
  font-size: 9px; letter-spacing: .05em; text-transform: uppercase; font-weight: 500;
  color: var(--black); padding: 6px 8px; cursor: pointer; user-select: none;
  transition: color .1s;
  border: 1px solid #f5f5f5; background: #f5f5f5;
}
.filter-label:hover { background: transparent; color: #000000; }
.filter-label.has-active { color: var(--black); }
.filter-label .arrow {
  font-size: 11px; font-style: normal; transition: transform .18s; display: inline-block; margin-left: 6px; flex-shrink: 0; opacity: 0.4; line-height: 1; vertical-align: middle;
}
.filter-label.open .arrow { transform: rotate(180deg); }
.filter-type-b .filter-label .ai-badge {
  font-size: 6px; color: var(--gray-light); letter-spacing: 0; margin-left: 3px;
}
/* DROPDOWN */
.filter-dropdown {
  display: none; width: 100%; box-sizing: border-box;
  position: absolute; top: 100%; left: -1px; right: -1px;
  z-index: 200;
  border: var(--border); border-top: none;
  background: #ffffff;
  max-height: 320px; overflow-y: auto;
  padding: 6px;
}
.filter-dropdown.open {
  display: grid;
  /* columns calculadas por JS al abrir — default 2 */
  grid-template-columns: repeat(var(--dd-cols, 2), 1fr);
  gap: 3px;
}
.tag {
  display: flex; align-items: center; justify-content: center;
  font-size: 8.5px; letter-spacing: 0.06em;
  border: var(--border); padding: 4px 6px; cursor: pointer; user-select: none;
  transition: all .1s; background: #ffffff; color: var(--gray-dark);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  width: 100%;
}
.tag:hover { background: var(--gray-xlight); }
.tag.active { background: var(--black); color: var(--white); border-color: var(--black); }
/* indicador de filtros activos en la pestaña */
.active-count {
  display: none; font-size: 7px; background: #FFD600; color: #000000;
  border-radius: 50%; width: 13px; height: 13px; align-items: center;
  justify-content: center; margin-left: 4px; flex-shrink: 0;
}
.active-count.visible { display: inline-flex; }

/* BARRA OBRA */
#page-title-bar {
  display: none; padding: 6px 24px 8px;
  font-size: 9.5px; letter-spacing: 0.1em; color: var(--gray-mid);
  align-items: center;
}
#obra-title-text { color: var(--black); font-weight: 400; }
.obra-fuente-link { color: var(--gray-mid); margin-left: 10px; font-size: 9px; letter-spacing: 0.1em; text-decoration: none; text-transform: uppercase; }
.obra-fuente-link:hover { color: var(--black); }
#back-btn { cursor: pointer; margin-right: 12px; }
#back-btn:hover { color: var(--black); }

/* CONTENIDO */
#main-content { padding: 0 24px 60px; }

/* GALERÍA */
#gallery { display: grid; grid-template-columns: repeat(4, 1fr); column-gap: 10px; row-gap: 28px; }
.cell-header { text-align: left; padding-bottom: 5px; }
.cell-autor { font-size: 10px; color: var(--gray-mid); text-transform: uppercase; letter-spacing: .05em; line-height: 1.3; cursor: pointer; }
.cell-autor:hover { color: var(--black); }
.cell-nombre { font-size: 11px; color: var(--black); font-weight: 500; line-height: 1.3; }
.gallery-cell {
  display: flex; flex-direction: column;
  cursor: pointer; background: #ffffff;
}
.cell-img-wrapper {
  width: 100%; aspect-ratio: 1/1; border: 1px solid #ffffff;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; padding: 12px; background: #ffffff;
}
.cell-img-wrapper img {
  max-width: 100%; max-height: 100%; object-fit: contain;
  display: block;
}
.gallery-cell:hover .cell-img-wrapper img { opacity: .85; }
.cover-cell .cell-img-wrapper { padding: 0; }
.cover-cell .cell-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
.cell-tags {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 4px; padding: 5px 0 0 0;
  opacity: 0; transition: opacity 0.15s;
  opacity: 0; transition: opacity 0.2s;
}
.gallery-cell:hover .cell-tags {
  opacity: 1;
}
.cell-tag {
  font-size: 7.5px; letter-spacing: 0.07em; border: 1px solid #f5f5f5;
  padding: 3px 4px; color: var(--gray-dark); cursor: pointer;
  user-select: none; background: #f5f5f5;
  text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.cell-tag:hover { background: transparent; color: var(--black); text-decoration: underline; }
.cell-tag-unknown { color: #bbb; cursor: default; }


/* ══ INTRO PAGE ══ */
#intro-page {
  display: none; position: fixed; inset: 0; z-index: 100;
  background: #fff; flex-direction: row;
}
#intro-page.active { display: flex; }
#intro-page.active ~ #site-header { display: none !important; }

/* COLUMNA IZQUIERDA */
#intro-left {
  width: 220px; min-width: 220px;
  display: flex; flex-direction: column;
  padding: 28px 20px 20px 24px;
  background: #fff;
  z-index: 102;
}
#intro-logo {
  width: 52px; height: 52px; border-radius: 50%;
  background: #FFD600;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; font-weight: 400; letter-spacing: 0.03em;
  color: #000; cursor: pointer; margin-bottom: 20px;
  flex-shrink: 0;
}
#intro-atlas {
  font-size: 8px; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--gray-mid); cursor: pointer; margin-top: -16px; margin-bottom: 20px;
  width: 52px; text-align: center;
}
#intro-atlas:hover { color: var(--black); }
#intro-autor {
  color: var(--gray-mid); margin-bottom: 3px; cursor: pointer;
}
#intro-autor:hover { color: var(--black); }
#intro-nombre {
  font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase;
  font-weight: 600; color: var(--black); margin-bottom: 16px; cursor: pointer;
  line-height: 1.4;
  height: 2.8em;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
#intro-nombre:hover { text-decoration: underline; }

/* TAGS dinámicos 2 cols x 6 filas */
#intro-tags {
  display: flex;
  flex-direction: column;
  gap: 3px;
  margin-bottom: 12px;
}
.intro-tag {
  padding: 3px 0;
  font-size: 7.5px; letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--gray-mid);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  background: transparent; border: none;
  text-align: left;
}
.intro-tag-link { cursor: pointer; position: relative; }
.intro-tag-link:hover { color: var(--black); }
.intro-tag-empty { opacity: 0; min-height: 1.4em; }
#intro-search-popup {
  display: none;
  position: fixed;
  z-index: 200;
  background: #fff;
  border: 1px solid #c8c8c8;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  min-width: 160px;
}
#intro-search-inp {
  border: none; outline: none;
  font-family: var(--font-mono);
  font-size: 8.5px; letter-spacing: 0.06em;
  width: 100%;
  padding: 5px 8px;
  background: transparent;
  color: var(--black);
  border-bottom: 1px solid #eee;
  box-sizing: border-box;
}
#intro-search-suggestions {
  max-height: 160px;
  overflow-y: auto;
}
.intro-search-sug {
  padding: 4px 8px;
  font-size: 8px; letter-spacing: 0.03em; text-transform: uppercase;
  color: var(--gray-mid);
  cursor: pointer;
  white-space: nowrap;
}
.intro-search-sug:hover, .intro-search-sug.active {
  background: var(--gray-xlight);
  color: var(--black);
}

#intro-filters { display: none; }

/* IMAGEN DERECHA */
#intro-bg {
  flex: 1;
  background: #fff;
  display: flex; align-items: center; justify-content: center;
  padding: 48px;
  box-sizing: border-box;
  overflow: hidden;
}
#intro-img-frame {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
}
#intro-img-frame img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
#intro-img-el {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  transition: opacity 0.6s ease;
  cursor: pointer;
}

#intro-click-zone {
  position: absolute; inset: 0; z-index: 101; pointer-events: none;
}

/* LIGHTBOX */
#lightbox {
  display: none; position: fixed; inset: 0; z-index: 999;
  background: #fff; align-items: stretch;
}
#lightbox.open { display: flex; }
#lb-img-area {
  flex: 1; display: flex; align-items: center; justify-content: center;
  cursor: pointer; overflow: hidden; padding: 48px 24px 48px 24px;
}
#lightbox img, #lightbox video {
  max-width: 100%; max-height: 100%;
  object-fit: contain; user-select: none;
}
#lb-video { display: none; background: #000; }
#lb-img { display: block; }
#lb-sidebar {
  width: 300px; flex-shrink: 0;
  background: #fff;
  padding: 48px 14px 24px 14px;
  overflow: hidden;
  font-family: var(--font-mono);
  opacity: 0;
  transition: opacity 0.15s;
  pointer-events: none;
}
#lightbox:hover #lb-sidebar {
  opacity: 1;
  pointer-events: auto;
}
#lb-tags-content {
  display: flex;
  flex-direction: column;
  height: 100%;
}
#lb-sidebar .lb-tag-group { display: contents; }
#lb-sidebar .lb-tag-group-label { display: none; }
#lb-sidebar .lb-tag {
  flex: 1;
  display: flex; align-items: center;
  padding: 0 6px;
  border: none;
  border-radius: 0;
  font-size: 7.5px; letter-spacing: 0.05em;
  color: #c0c0c0; cursor: pointer;
  text-transform: none;
  box-sizing: border-box; overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap;
  min-height: 0;
}
#lb-sidebar .lb-tag:hover { color: var(--black); background: #fafafa; }
#lb-sidebar .lb-tag.active { color: var(--black); font-weight: 700; background: none; }
#lb-sidebar .lb-tag:hover { border-color: var(--black); color: var(--black); }
#lb-close {
  position: fixed; top: 24px; right: 28px; font-family: var(--font-mono);
  font-size: 10px; letter-spacing: 0.12em; cursor: pointer;
  color: var(--gray-dark); user-select: none; text-transform: uppercase;
  z-index: 1001;
}
#lb-close:hover { color: var(--black); }

/* FILTER POPUP */
#lb-popup {
  display: none; position: fixed; inset: 0; z-index: 1000;
  background: #fff;
  flex-direction: column;
}
#lb-popup.open { display: flex; }
#lb-popup-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 22px 28px; flex-shrink: 0;
  font-family: var(--font-mono); font-size: 8px; letter-spacing: 0.12em;
  text-transform: uppercase;
}
#lb-popup-close {
  font-size: 10px; letter-spacing: 0.12em;
  cursor: pointer; color: var(--gray-dark); text-transform: uppercase;
}
#lb-popup-close:hover { color: var(--black); }
#lb-popup-title {
  color: var(--gray-mid);
}
#lb-popup-gallery {
  flex: 1; overflow-y: auto;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 3px; padding: 0 3px 3px;
}

/* EMPTY */
#empty-state {
  display: none; grid-column: 1/-1; padding: 60px 0; text-align: center;
  font-size: 10px; letter-spacing: 0.12em; color: var(--gray-light); text-transform: uppercase;
}

@media (max-width: 900px) {
  .filter-row { grid-template-columns: repeat(3, 1fr); }
  #gallery { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<div id="intro-page" class="active">
  <div id="intro-left">
    <div id="intro-logo" onclick="enterBrowser(null)">MAB</div>
    <div id="intro-atlas" onclick="enterBrowser(null)">ATLAS</div>
    <div id="intro-nombre"></div>
    <div id="intro-tags"></div>
  </div>
  <div id="intro-search-popup"><input id="intro-search-inp" type="text" placeholder="buscar..."><div id="intro-search-suggestions"></div></div>
  <div id="intro-bg">
    <div id="intro-img-frame">
      <img id="intro-img-el" src="" alt="" onclick="(function(){var id=document.getElementById('intro-tags').dataset.obraId;enterBrowser(id);})()">
    </div>
  </div>
</div>

<header id="site-header">
  <div id="top-bar">
    <div id="logo" onclick="goHome()">MAB - Modern Architecture Browser</div>
    <div id="top-btns">
      <!-- ESTADO: botón desplegable independiente del grid -->
      <div id="estado-btn-group">
        <button id="btn-estado" onclick="toggleEstado()" title="Filtrar por estado de obra">◉</button>
        <div id="fi-estado"></div>
      </div>
      <button id="btn-intro" onclick="goIntro()" title="Inicio">⊙</button>
      <button id="btn-reset" onclick="resetAll()" title="Limpiar filtros">↺</button>
      <button id="share-btn" onclick="shareFilters()" title="Compartir selección">⇪</button>
      <button id="pdf-btn" onclick="exportPDF()" title="Exportar selección a PDF">⬇</button>
    </div>
  </div>

  <div id="filters-wrapper">
    <div class="filter-row">
      <div class="filter-group" id="fg-autor">
        <div class="filter-label" onclick="toggleDropdown('autor')">Autor <span class="active-count" id="ac-autor"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-autor"></div>
      </div>
      <div class="filter-group" id="fg-uso">
        <div class="filter-label" onclick="toggleDropdown('uso')">Uso <span class="active-count" id="ac-uso"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-uso"></div>
      </div>
      <div class="filter-group" id="fg-pais">
        <div class="filter-label" onclick="toggleDropdown('pais')">País <span class="active-count" id="ac-pais"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-pais"></div>
      </div>
      <div class="filter-group" id="fg-ciudad">
        <div class="filter-label" onclick="toggleDropdown('ciudad')">Ciudad <span class="active-count" id="ac-ciudad"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-ciudad"></div>
      </div>
      <div class="filter-group" id="fg-decada">
        <div class="filter-label" onclick="toggleDropdown('decada')">Década <span class="active-count" id="ac-decada"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-decada"></div>
      </div>
      <div class="filter-group" id="fg-anio">
        <div class="filter-label" onclick="toggleDropdown('anio')">Año <span class="active-count" id="ac-anio"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-anio"></div>
      </div>
    </div>
    <div class="filter-row">
      <div class="filter-group" id="fg-fotografo">
        <div class="filter-label" onclick="toggleDropdown('fotografo')">Fotógrafo <span class="active-count" id="ac-fotografo"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-fotografo"></div>
      </div>
      <div class="filter-group" id="fg-complejidad">
        <div class="filter-label" onclick="toggleDropdown('complejidad')">Complejidad <span class="active-count" id="ac-complejidad"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-complejidad"></div>
      </div>
      <div class="filter-group filter-type-b" id="fg-material">
        <div class="filter-label" onclick="toggleDropdown('material')">Material <span class="active-count" id="ac-material"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-material"></div>
      </div>
      <div class="filter-group filter-type-b" id="fg-componente">
        <div class="filter-label" onclick="toggleDropdown('componente')">Componente <span class="active-count" id="ac-componente"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-componente"></div>
      </div>
      <div class="filter-group filter-type-b" id="fg-tipografica">
        <div class="filter-label" onclick="toggleDropdown('tipografica')">Tip. gráfica <span class="active-count" id="ac-tipografica"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-tipografica"></div>
      </div>
      <div class="filter-group filter-type-b" id="fg-tipoespacial">
        <div class="filter-label" onclick="toggleDropdown('tipoespacial')">Tip. espacial <span class="active-count" id="ac-tipoespacial"></span><span class="arrow">⌄</span></div>
        <div class="filter-dropdown" id="fi-tipoespacial"></div>
      </div>
    </div>
  </div>

  <div id="page-title-bar">
    <span id="back-btn" onclick="goHome()">Atlas &nbsp;</span>
    <span id="obra-title-text"></span>
  </div>

</header>

<main id="main-content">
  <div id="gallery">
    <div id="empty-state">No se encontraron obras con los filtros seleccionados</div>
  </div>
</main>

<div id="lightbox">
  <div id="lb-close" onclick="lbClose(event)">✕</div>
  <div id="lb-sidebar">
    <div id="lb-tags-content"></div>
  </div>
  <div id="lb-img-area" onclick="lbNext()">
    <img id="lb-img" src="" alt="">
    <video id="lb-video" controls autoplay loop style="display:none;max-width:100%;max-height:100%;cursor:pointer;" onclick="lbNext()"></video>
  </div>
</div>

<div id="lb-popup">
  <div id="lb-popup-header">
    <div id="lb-popup-title"></div>
    <div id="lb-popup-close" onclick="lbPopupClose()">✕ VOLVER</div>
  </div>
  <div id="lb-popup-gallery"></div>
</div>

<script src="obras.js"></script>
<script>
// ══════════════════════════════════════════
//  BASE DE DATOS
// ══════════════════════════════════════════
// OBRAS cargadas desde obras.js;

// ── JERARQUÍA USO ─────────────────────────────────────────
const USO_JERARQUIA = {
  "Residencia":                ["Cabaña","Casa unifamiliar","Edificio de vivienda","Loft","Refugio","Vivienda colectiva","Vivienda social"],
  "Educación":                 ["Aula magna","Campus universitario","Escuela primaria","Escuela secundaria","Facultad","Instituto técnico","Jardín de infantes","Universidad"],
  "Cultura":                   ["Archivo","Auditorio","Biblioteca","Centro cultural","Cinema","Fundación","Museo","Sala de exposiciones","Teatro"],
  "Religión":                  ["Capilla","Catedral","Cementerio","Crematorio","Iglesia","Mezquita","Sinagoga"],
  "Salud":                     ["Centro de salud","Clínica","Geriátrico","Hospital","Laboratorio"],
  "Deporte y recreación":      ["Arena","Club","Estadio","Gimnasio","Parque deportivo","Piscina","Velódromo"],
  "Oficinas y trabajo":        ["Coworking","Edificio de oficinas","Edificio gubernamental","Embajada","Palacio de justicia","Parlamento","Sede institucional","Torre corporativa"],
  "Comercio y hospitalidad":   ["Centro comercial","Hostel","Hotel","Local comercial","Mercado","Resort","Showroom"],
  "Infraestructura":           ["Aeropuerto","Estación de tren","Planta de energía","Puerto","Puente","Terminal de buses","Túnel"],
  "Industria":                 ["Bodega","Depósito","Fábrica","Frigorífico","Hangar","Planta industrial","Silo"],
  "Espacio público y paisaje": ["Costanera","Intervención urbana","Jardín público","Masterplan","Paisajismo","Parque","Paseo","Plaza"],
  "Efímero y experimental":    ["Escenografía","Instalación","Pabellón","Prototipo"],
};
// Lista plana alfabética (categorías + subtipos)
const USO_TODOS = [...new Set([
  ...Object.keys(USO_JERARQUIA),
  ...Object.values(USO_JERARQUIA).flat()
])].sort();
// Dado un tag de uso activo, retorna todos los subtipos que incluye (o solo él mismo si es subtipo)
function usoExpand(tag) {
  if (USO_JERARQUIA[tag]) return [tag, ...USO_JERARQUIA[tag]];
  return [tag];
}
const AF = { autor:[], estado:[], uso:[], pais:[], ciudad:[], decada:[], anio:[], fotografo:[], complejidad:[], material:[], componente:[], tipografica:[], tipoespacial:[] };
let currentObraId = null;
let lbImages = []; // array of {src, elementos, tipografica, extra, obra}
let lbIdx = 0;

function getFotografos(o) {
  return Array.isArray(o.fotografo) ? o.fotografo : (o.fotografo ? [o.fotografo] : []);
}
function getAutores(o) {
  return Array.isArray(o.autor) ? o.autor : (o.autor ? [o.autor] : []);
}

// ══════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════

function toggleEstado() {
  const dd = document.getElementById('fi-estado');
  const wasOpen = dd.classList.contains('open');
  closeAllDropdowns();
  if (!wasOpen) dd.classList.add('open');
}

function calcDropdownCols(dd) {
  // Medir el tag más largo para decidir cuántas columnas caben
  const tags = dd.querySelectorAll('.tag');
  if (!tags.length) return 2;
  // Ancho disponible del dropdown (igual al botón del filtro)
  const available = dd.offsetWidth || dd.parentElement.offsetWidth || 120;
  // Crear canvas temporal para medir texto
  const ctx = document.createElement('canvas').getContext('2d');
  ctx.font = '8.5px Arial';
  let maxW = 0;
  tags.forEach(t => {
    const w = ctx.measureText(t.textContent).width + 20; // padding 10px × 2
    if (w > maxW) maxW = w;
  });
  // Cuántas columnas caben sin que el tag más largo se trunque
  const cols = Math.max(1, Math.min(3, Math.floor(available / maxW)));
  return cols;
}

function toggleDropdown(key) {
  const dd = document.getElementById('fi-' + key);
  const lbl = dd.previousElementSibling;
  const wasOpen = dd.classList.contains('open');
  closeAllDropdowns();
  if (!wasOpen) {
    dd.classList.add('open');
    lbl.classList.add('open');
    // Calcular columnas después de que el dropdown sea visible
    requestAnimationFrame(() => {
      const cols = calcDropdownCols(dd);
      dd.style.setProperty('--dd-cols', cols);
    });
  }
}

function closeAllDropdowns() {
  document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('open'));
  document.querySelectorAll('.filter-label').forEach(l => l.classList.remove('open'));
  const est = document.getElementById('fi-estado');
  if (est) est.classList.remove('open');
}

function updateActiveCount(key) {
  if (key === 'estado') {
    const btn = document.getElementById('btn-estado');
    if (!btn) return;
    AF.estado.length ? btn.classList.add('has-active') : btn.classList.remove('has-active');
    return;
  }
  const n = AF[key] ? AF[key].length : 0;
  const el = document.getElementById('ac-' + key);
  if (!el) return;
  el.textContent = n;
  n > 0 ? el.classList.add('visible') : el.classList.remove('visible');
  const lbl = el.closest('.filter-label');
  if (lbl) n > 0 ? lbl.classList.add('has-active') : lbl.classList.remove('has-active');
}

function buildTags() {
  // Fotógrafo: soporta string legacy o array
  const allFotografos = [...new Set(OBRAS.flatMap(o =>
    getFotografos(o).filter(f => f && f !== 'Sin crédito')
  ))].sort();

  const sets = {
    autor:       [...new Set(OBRAS.flatMap(o => getAutores(o)))].sort(),
    pais:        [...new Set(OBRAS.map(o => o.pais))].sort(),
    ciudad:      [...new Set(OBRAS.map(o => o.ciudad))].sort(),
    decada:      [...new Set(OBRAS.map(o => o.decada))].sort(),
    anio:        [...new Set(OBRAS.map(o => String(o.anio)))].sort(),
    fotografo:   allFotografos,
    complejidad: ["Nivel 1","Nivel 2","Nivel 3","Nivel 4","Nivel 5"],
    uso:         USO_TODOS,
    material: ["Acero","Acero corten","Acero inoxidable","Adobe","Aluminio","Arenisca","Bambu","Bronce","CLT","Caliza","Ceramica","Cobre","Tierra compactada","Granito","Hierro","Hormigon","Ladrillo","Madera laminada","Madera maciza","Membrana ETFE","PVC","Piedra","Pizarra","Policarbonato","Porcelana","Terracota","Titanio","Vidrio","Vidrio laminado","Vidrio templado","Yeso","Zinc"],
    componente:  ["Aire acondicionado","Artefacto sanitario","Ascensor","Barandilla","Canaleta","Carpinteria","Cerco","Cielorraso","Columna","Cubierta","Entrepiso","Escalera","Estructura","Fachada ventilada","Griferia","Hogar","Iluminacion","Instalacion de incendio","Instalacion pluvial","Lucarna","Manija","Marquesina","Muro compuesto","Muro opaco","Muro translucido","Muro transparente","Panel","Parasol","Parrilla","Persiana","Piso","Porton","Postigo","Puerta","Rampa","Revestimiento","Senaletica","Toldo","Viga"],
    tipografica: ["Axonometria","Corte","Despiece","Detalle constructivo","Foto de maqueta","Fotomontaje","Maqueta","Maqueta virtual","Perfil urbano","Perspectiva exterior","Perspectiva interior","Planimetria","Planta","Render exterior","Render interior","Vista"],
    tipoespacial: ["Aula","Auditorio","Baño","Biblioteca","Calle","Cocina","Comedor","Consultorio","Deposito","Dormitorio","Espacio deportivo","Espacio industrial","Estacionamiento","Estar","Foyer","Galeria","Garaje cubierto","Hall de ingreso","Invernadero","Jardin","Lobby","Oficina","Patio","Piscina cubierta","Plaza","Sala de espera","Sala de lectura","Sala de reuniones","Showroom","Terraza","Vereda","Vestuario"]
  };

  // Poblar estado (botón separado)
  const estEl = document.getElementById('fi-estado');
  if (estEl) {
    ["Construido","No construido","Demolido","Restaurado","Reconstruido"].forEach(v => {
      const t = document.createElement('span');
      t.className = 'tag'; t.textContent = v;
      t.dataset.k = 'estado'; t.dataset.v = v;
      t.onclick = () => {
        const a = AF.estado, i = a.indexOf(v);
        i === -1 ? (a.push(v), t.classList.add('active')) : (a.splice(i,1), t.classList.remove('active'));
        updateActiveCount('estado');
        const intro = document.getElementById('intro-page');
        if (intro && intro.classList.contains('active')) { enterBrowser(null); return; }
        renderHome();
      };
      estEl.appendChild(t);
    });
  }

  Object.entries(sets).forEach(([key, vals]) => {
    const el = document.getElementById('fi-' + key);
    if (!el) return;
    // Input de búsqueda
    const inp = document.createElement('input');
    inp.type = 'text'; inp.placeholder = 'Buscar...';
    inp.style.cssText = 'grid-column: 1 / -1; width:100%; border:none; border-bottom:1px solid #c8c8c8; padding:5px 8px; font-family:inherit; font-size:8.5px; letter-spacing:0.06em; outline:none; margin-bottom:2px; background:#fff; flex-shrink:0;';
    inp.onclick = e => e.stopPropagation();
    inp.oninput = () => {
      const q = inp.value.toLowerCase();
      el.querySelectorAll('.tag').forEach(t => {
        t.style.display = (!q || t.textContent.toLowerCase().startsWith(q)) ? '' : 'none';
      });
    };
    el.appendChild(inp);
    vals.forEach(v => {
      if (!v || v === '—') return;
      const t = document.createElement('span');
      t.className = 'tag'; t.textContent = v;
      t.dataset.k = key; t.dataset.v = v;
      t.onclick = () => toggleF(key, v, t);
      el.appendChild(t);
    });
  });
}

function toggleF(key, val, el) {
  const a = AF[key], i = a.indexOf(val);
  i === -1 ? (a.push(val), el && el.classList.add('active')) : (a.splice(i,1), el && el.classList.remove('active'));
  updateActiveCount(key);
  // Si el popup está abierto, cerrarlo todo y ir al buscador
  const popup = document.getElementById('lb-popup');
  if (popup && popup.classList.contains('open')) {
    popup.classList.remove('open');
    document.getElementById('lightbox').classList.remove('open');
    currentObraId = null;
    document.getElementById('page-title-bar').style.display = 'none';
    renderHome();
    return;
  }
  const intro = document.getElementById('intro-page');
  if (intro && intro.classList.contains('active')) { enterBrowser(null); return; }
  renderHome();
}

function resetAll() {
  Object.keys(AF).forEach(k => AF[k] = []);
  document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
  Object.keys(AF).forEach(k => updateActiveCount(k));
  closeAllDropdowns();
  currentObraId ? renderObra(currentObraId) : renderHome();
}

// ══════════════════════════════════════════
//  MATCH
// ══════════════════════════════════════════
function obraMatch(o) {
  if (AF.autor.length && !AF.autor.some(a => getAutores(o).includes(a))) return false;
  if (AF.estado.length && !AF.estado.includes(o.estado)) return false;
  if (AF.uso.length) {
    // Expandir cada tag activo: si es categoría incluye todos sus subtipos
    const expanded = [...new Set(AF.uso.flatMap(t => usoExpand(t)))];
    if (!expanded.includes(o.uso)) return false;
  }
  if (AF.pais.length && !AF.pais.includes(o.pais)) return false;
  if (AF.ciudad.length && !AF.ciudad.includes(o.ciudad)) return false;
  if (AF.decada.length && !AF.decada.includes(o.decada)) return false;
  if (AF.anio.length && !AF.anio.includes(String(o.anio))) return false;
  if (AF.fotografo.length && !AF.fotografo.some(f => getFotografos(o).includes(f))) return false;
  if (AF.complejidad.length && !AF.complejidad.includes(o.complejidad)) return false;
  // Filtros B: si hay activos, la obra debe tener al menos una imagen que los cumpla todos
  const hasFiltrosB = AF.material.length || AF.componente.length || AF.tipografica.length || AF.tipoespacial.length;
  if (hasFiltrosB && !o.imagenes.some(img => imgMatch(img))) return false;
  return true;
}
function imgMatch(img) {
  // Filtro tipografica (independiente de elementos)
  if (AF.tipografica.length && !AF.tipografica.some(t => (img.tipografica||[]).includes(t))) return false;

  // Filtros B: tipoespacial + material + componente deben coincidir dentro del MISMO elemento
  const hasFiltrosB = AF.tipoespacial.length || AF.material.length || AF.componente.length;
  if (!hasFiltrosB) return true;

  const elementos = img.elementos || [];

  // Debe existir al menos UN elemento que satisfaga TODOS los filtros B activos simultaneamente
  return elementos.some(el => {
    if (AF.tipoespacial.length && !AF.tipoespacial.includes(el.tipoespacial)) return false;
    if (AF.material.length && !AF.material.includes(el.material)) return false;
    if (AF.componente.length && !AF.componente.includes(el.componente)) return false;
    return true;
  });
}


// Helper: extraer valores únicos de elementos por campo
function elemVals(img, campo) {
  return [...new Set((img.elementos||[]).map(el => el[campo]).filter(Boolean))];
}
// ══════════════════════════════════════════
//  RENDER HOME
// ══════════════════════════════════════════
function renderHome() {
  currentObraId = null;
  document.getElementById('page-title-bar').style.display = 'none';
  document.title = 'MAB - Modern Architecture Browser';
  const g = document.getElementById('gallery');
  g.innerHTML = '';

  const hasFiltrosB = AF.tipografica.length || AF.tipoespacial.length || AF.material.length || AF.componente.length;

  if (hasFiltrosB) {
    // MODO IMAGEN CRUZADA: mostrar todas las imágenes de todas las obras que cumplan filtros A + B
    const obrasVisibles = OBRAS.filter(obraMatch);
    const todasLasImagenes = [];
    obrasVisibles.forEach(o => {
      o.imagenes.filter(imgMatch).forEach(img => {
        todasLasImagenes.push({ img, obra: o });
      });
    });

    if (!todasLasImagenes.length) {
      g.innerHTML = '<div id="empty-state" style="display:block">No se encontraron imágenes con los filtros seleccionados</div>';
      return;
    }

    // RANKING: ordenar por score de coincidencias con filtros activos
    todasLasImagenes.forEach(item => {
      let score = 0;
      const img = item.img;
      const allTags = [
        ...(img.tipografica||[]),
        ...elemVals(img, "tipoespacial"),
        ...elemVals(img, "material"),
        ...elemVals(img, "componente"),
      ];
      if (AF.material.length)     score += AF.material.filter(v => elemVals(img,"material").includes(v)).length * 10;
      if (AF.componente.length)   score += AF.componente.filter(v => elemVals(img,"componente").includes(v)).length * 10;
      if (AF.tipografica.length)  score += AF.tipografica.filter(v => (img.tipografica||[]).includes(v)).length * 10;
      if (AF.tipoespacial.length) score += AF.tipoespacial.filter(v => elemVals(img,"tipoespacial").includes(v)).length * 10;
      // Bonus: menos tags totales = más preponderante el tag activo
      score += Math.max(0, 10 - allTags.length);
      item.score = score;
    });
    todasLasImagenes.sort((a, b) => b.score - a.score);

    lbImages = todasLasImagenes.map(x => ({ src: x.img.src, elementos: x.img.elementos||[], tipografica: x.img.tipografica||[], extra: x.img.extra||[], obra: x.obra }));
    lbIdx = 0;

    todasLasImagenes.forEach(({ img, obra }, idx) => {
      const cell = mkCell(img.src, getAutores(obra).join(' + '), () => lbOpen(idx), getAutores(obra), obra.nombre);
      // Tags B primero, completar con A
      const tagsB = [
        ...img.tipografica.map(v => ({k:'tipografica',v})),
        ...elemVals(img,'tipoespacial').map(v => ({k:'tipoespacial',v})),
        ...elemVals(img,'material').map(v => ({k:'material',v})),
        ...elemVals(img,'componente').map(v => ({k:'componente',v})),
      ].filter(x => x.v);
      const tagsA = [
        ...getAutores(obra).map(a=>({k:'autor',v:a})),
        {k:'uso', v:obra.uso}, {k:'pais', v:obra.pais},
        {k:'ciudad', v:obra.ciudad}, {k:'decada', v:obra.decada}, {k:'anio', v:String(obra.anio)},
        ...getFotografos(obra).filter(f=>f&&f!=='Sin crédito').map(f=>({k:'fotografo',v:f})),
        {k:'complejidad', v:obra.complejidad}
      ].filter(x => x.v && x.v !== 'Sin datos');
      const combined = [...tagsB];
      for (const a of tagsA) { if (combined.length >= 8) break; combined.push(a); }
      cell.appendChild(mkTagsDiv8(combined));
      g.appendChild(cell);
    });

  } else {
    // MODO CARÁTULAS: mostrar una carátula por obra (última obra primero)
    const vis = [...OBRAS].filter(obraMatch);
    if (!vis.length) {
      g.innerHTML = '<div id="empty-state" style="display:block">No se encontraron obras con los filtros seleccionados</div>';
      return;
    }
    vis.forEach(o => {
      const autLabel = getAutores(o).join(' + ');
      const cell = mkCell(o.cover, autLabel + ' — ' + o.nombre, () => renderObra(o.id), getAutores(o), o.nombre);
      cell.classList.add('cover-cell');
      const tagData = [
        ...getAutores(o).map(a=>({k:'autor',v:a})),
        {k:'uso', v:o.uso}, {k:'pais', v:o.pais},
        {k:'ciudad', v:o.ciudad}, {k:'decada', v:o.decada}, {k:'anio', v:String(o.anio)},
        ...getFotografos(o).filter(f=>f&&f!=='Sin crédito').map(f=>({k:'fotografo',v:f})),
        {k:'complejidad', v:o.complejidad}
      ];
      cell.appendChild(mkTagsDiv8(tagData, true));
      g.appendChild(cell);
      attachHoverSlideshow(cell, o);
    });
  }
}

// ══════════════════════════════════════════
//  RENDER OBRA
// ══════════════════════════════════════════
function renderObra(id) {
  currentObraId = id;
  const o = OBRAS.find(x => x.id === id);
  document.getElementById('page-title-bar').style.display = 'flex';
  // Título como tags separados
  const titleEl = document.getElementById('obra-title-text');
  titleEl.innerHTML = '';
  const autorLabel = getAutores(o).join(' + ');
  const autorSpan = document.createElement('span');
  autorSpan.textContent = autorLabel;
  autorSpan.style.cssText = 'cursor:pointer; text-decoration:underline; text-underline-offset:2px;';
  autorSpan.onclick = e => {
    e.stopPropagation(); goHome();
    getAutores(o).forEach(a => { const ft = document.querySelector(`.tag[data-k="autor"][data-v="${a}"]`); if (ft) toggleF('autor', a, ft); });
  };
  const sep = document.createTextNode(' — ');
  const nombreSpan = document.createElement('span');
  nombreSpan.textContent = o.nombre;
  titleEl.appendChild(autorSpan); titleEl.appendChild(sep); titleEl.appendChild(nombreSpan);
  // Link fuente
  // Limpiar fuentes anteriores
  document.querySelectorAll('.obra-fuente-link').forEach(el => el.remove());
  if (o.url) {
    const urls = Array.isArray(o.url) ? o.url : [o.url];
    const bar = document.getElementById('page-title-bar');
    urls.forEach((url, i) => {
      const a = document.createElement('a');
      a.className = 'obra-fuente-link';
      a.href = url;
      a.target = '_blank';
      a.textContent = i === 0 ? 'Fuente' : 'Fuente ' + (i + 1);
      bar.appendChild(a);
    });
  }
  document.title = autorLabel + ' · MAB';

  const g = document.getElementById('gallery');
  g.innerHTML = '';

  let imgs = o.imagenes;
  const hasF = AF.tipografica.length || AF.tipoespacial.length || AF.material.length || AF.componente.length;
  if (hasF) imgs = imgs.filter(imgMatch);

  if (!imgs.length) { g.innerHTML = '<div id="empty-state" style="display:block">Sin imágenes para los filtros activos</div>'; return; }

  // Orden por campo escala (1-16)
  // Sin escala: fotos sin tipografica → 3, dibujos → inferir por tipo
  const escalaFallback = i => {
    if (i.escala) return i.escala;
    if (!i.tipografica || !i.tipografica.length) return 3; // foto sin clasificar
    const t = i.tipografica[0] || '';
    if (t === 'Planimetria' || t === 'Perfil urbano')   return 7;
    if (t === 'Planta')                                  return 9;
    if (t === 'Corte')                                   return 10;
    if (t === 'Vista')                                   return 11;
    if (t === 'Axonometria')                             return 12;
    if (t === 'Detalle constructivo' || t === 'Despiece')return 13;
    if (t === 'Render interior' || t === 'Render exterior' || t === 'Perspectiva interior' || t === 'Perspectiva exterior' || t === 'Fotomontaje' || t === 'Maqueta virtual') return 15;
    if (t === 'Foto de maqueta' || t === 'Maqueta')       return 16;
    return 14;
  };
  imgs = [...imgs].sort((a, b) => escalaFallback(a) - escalaFallback(b));
  lbImages = imgs.map(i => ({ src: i.src, elementos: i.elementos||[], tipografica: i.tipografica||[], extra: i.extra||[], obra: o })); lbIdx = 0;

  imgs.forEach((img, idx) => {
    const cell = mkCell(img.src, '', () => lbOpen(idx));
    // Filtros B (prioridad)
    const tagsB = [
      ...img.tipografica.map(v => ({k:'tipografica',v})),
      ...elemVals(img,'tipoespacial').map(v => ({k:'tipoespacial',v})),
      ...elemVals(img,'material').map(v => ({k:'material',v})),
      ...elemVals(img,'componente').map(v => ({k:'componente',v}))
    ].filter(x => x.v);
    // Filtros A de la obra (fallback)
    const tagsA = [
      ...getAutores(o).map(a=>({k:'autor',v:a})),
      {k:'uso', v:o.uso}, {k:'pais', v:o.pais},
      {k:'ciudad', v:o.ciudad}, {k:'decada', v:o.decada}, {k:'anio', v:String(o.anio)},
      ...getFotografos(o).filter(f=>f&&f!=='Sin crédito').map(f=>({k:'fotografo',v:f})),
      {k:'complejidad', v:o.complejidad}
    ].filter(x => x.v && x.v !== '—');
    // Combinar: B primero, luego A para completar hasta 8 sin repetir
    const combined = [...tagsB];
    for (const a of tagsA) {
      if (combined.length >= 8) break;
      combined.push(a);
    }
    const td = mkTagsDiv8(combined);
    cell.appendChild(td);
    g.appendChild(cell);
  });
}

// ══════════════════════════════════════════
//  HELPERS
// ══════════════════════════════════════════
function mkCell(src, alt, clickFn, autor, nombre) {
  const cell = document.createElement('div');
  cell.className = 'gallery-cell';
  cell.onclick = clickFn;
  if (autor !== undefined || nombre !== undefined) {
    const header = document.createElement('div');
    header.className = 'cell-header';
    if (autor) {
      const autores = Array.isArray(autor) ? autor : [autor];
      const div = document.createElement('div');
      div.className = 'cell-autor';
      autores.forEach((a, i) => {
        if (i > 0) {
          const sep = document.createElement('span');
          sep.textContent = ' + ';
          sep.style.cssText = 'cursor:default; pointer-events:none; text-decoration:none;';
          div.appendChild(sep);
        }
        const span = document.createElement('span');
        span.textContent = a;
        span.style.cssText = 'cursor:pointer;';
        span.onmouseenter = () => span.style.textDecoration = 'underline';
        span.onmouseleave = () => span.style.textDecoration = 'none';
        span.onclick = e => {
          e.stopPropagation();
          const ft = document.querySelector(`.tag[data-k="autor"][data-v="${a}"]`);
          if (ft) toggleF('autor', a, ft);
        };
        div.appendChild(span);
      });
      header.appendChild(div);
    }
    if (nombre) {
      const n = document.createElement('div');
      n.className = 'cell-nombre';
      n.textContent = nombre;
      header.appendChild(n);
    }
    cell.appendChild(header);
  }
  const w = document.createElement('div');
  w.className = 'cell-img-wrapper';
  const img = document.createElement('img');
  img.src = src; img.alt = alt; img.loading = 'lazy';
  img.onerror = () => { cell.style.display = 'none'; };
  img.onload = () => {
    // Drive sz=w1600 thumbnails válidos son siempre >= 300px de ancho.
    // Si es más chico es el placeholder de archivo borrado.
    if (img.naturalWidth < 300 || img.naturalHeight < 200) {
      cell.style.display = 'none';
    }
  };
  w.appendChild(img); cell.appendChild(w);
  return cell;
}

function attachHoverSlideshow(cell, obra) {
  if (!obra) return;
  const imgs = obra.imagenes;
  if (imgs.length <= 1) return;
  let timer = null;
  let idx = 0;
  const imgEl = cell.querySelector('img');
  const original = imgEl.src;
  cell.addEventListener('mouseenter', () => {
    idx = 0;
    timer = setInterval(() => {
      idx = (idx + 1) % imgs.length;
      const testImg = new Image();
      testImg.onload = () => {
        // Si Drive devuelve placeholder (borrada) saltear
        if (testImg.naturalWidth < 300 || testImg.naturalHeight < 200) return;
        imgEl.src = imgs[idx].src;
      };
      testImg.src = imgs[idx].src;
    }, 1000);
  });
  cell.addEventListener('mouseleave', () => {
    clearInterval(timer);
    imgEl.src = original;
  });
}

function mkTagsDiv8(data) {
  const div = document.createElement('div');
  div.className = 'cell-tags';
  // v07 — USO (no ESTADO) en tags de carátulas e imágenes
  const slots = data.slice(0, 8);
  while (slots.length < 8) slots.push({k: null, v: null});
  slots.forEach(({k, v}) => {
    const t = document.createElement('span');
    const val = (!v || v === '—' || v === 'Sin datos') ? 'Sin datos' : v;
    t.className = 'cell-tag' + (val === 'Sin datos' ? ' cell-tag-unknown' : '');
    t.textContent = val;
    if (k && val && val !== 'Sin datos') {
      t.onclick = e => {
        e.stopPropagation();
        const ft = document.querySelector(`.tag[data-k="${k}"][data-v="${v}"]`);
        if (ft) toggleF(k, v, ft);
      };
    }
    div.appendChild(t);
  });
  return div;
}


// ══════════════════════════════════════════
//  INTRO PAGE
// ══════════════════════════════════════════
let introTimer = null;

// Pool pre-filtrado: solo imágenes horizontales confirmadas
// Se construye asincrónicamente al inicio
let introPool = [];
let introPoolIdx = 0;

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function noConsecutivos(pool) {
  // Garantiza que nunca dos items seguidos sean de la misma obra
  const result = [];
  const temp = [...pool];
  while (temp.length) {
    const lastId = result.length ? result[result.length - 1].obra.id : null;
    const idx = temp.findIndex(x => x.obra.id !== lastId);
    if (idx === -1) { result.push(...temp); break; }
    result.push(temp.splice(idx, 1)[0]);
  }
  return result;
}

function buildIntroPool(callback) {
  // Candidatos: fotos (no dibujos), coverimage de cada obra primero para máxima velocidad
  const candidatos = [];
  OBRAS.forEach(o => {
    o.imagenes.forEach(img => {
      if (!img.tipografica || img.tipografica.length === 0) {
        candidatos.push({ src: img.src, obra: o, img: img });
      }
    });
  });

  shuffle(candidatos);

  if (!candidatos.length) { callback && callback(); return; }

  // FAST START: verificar covers y arrancar solo con las horizontales
  const fastSeed = [];
  let coversPending = OBRAS.filter(o => o.cover).length;
  if (!coversPending) { callback && callback(); }
  OBRAS.forEach(o => {
    if (!o.cover) return;
    const t = new Image();
    t.onload = () => {
      if (t.naturalWidth >= 300 && t.naturalHeight >= 200 &&
          t.naturalWidth / t.naturalHeight >= 1.4) {
        fastSeed.push({ src: o.cover, obra: o, img: o.imagenes[0] || {} });
      }
      coversPending--;
      if (coversPending === 0) {
        if (fastSeed.length) {
          shuffle(fastSeed);
          introPool = noConsecutivos(fastSeed);
          introPoolIdx = 0;
        }
        callback && callback();
      }
    };
    t.onerror = () => {
      coversPending--;
      if (coversPending === 0) callback && callback();
    };
    t.src = o.cover;
  });

  // En paralelo, verificar dimensiones reales para armar el pool completo
  let checked = 0;
  const horizontales = [];
  let poolCompleto = false;

  candidatos.forEach(item => {
    const t = new Image();
    t.onload = () => {
      // Ignorar imágenes placeholder de Drive (borradas)
      if (t.naturalWidth >= 300 && t.naturalHeight >= 200 &&
          t.naturalWidth / t.naturalHeight >= 1.4) {
        horizontales.push(item);
      }
      checked++;
      if (checked === candidatos.length && !poolCompleto) {
        poolCompleto = true;
        if (horizontales.length) {
          shuffle(horizontales);
          introPool = noConsecutivos(horizontales);
          // No reiniciamos introPoolIdx para no interrumpir la imagen actual
        }
        if (!fastSeed.length) callback && callback();
      }
    };
    t.onerror = () => {
      checked++;
      if (checked === candidatos.length && !poolCompleto) {
        poolCompleto = true;
        if (horizontales.length) {
          shuffle(horizontales);
          introPool = noConsecutivos(horizontales);
        }
        if (!fastSeed.length) callback && callback();
      }
    };
    t.src = item.src;
  });
}

function introShowNext() {
  if (!introPool.length) return;
  const item = introPool[introPoolIdx % introPool.length];
  introPoolIdx++;

  const imgEl = document.getElementById('intro-img-el');
  imgEl.style.opacity = '0';
  imgEl.src = item.src;
  imgEl.onload = () => { imgEl.style.opacity = '1'; };
  imgEl.onerror = () => { introShowNext(); };
  updateIntroMeta(item);
}

function updateIntroMeta(item) {
  const tagsDiv = document.getElementById('intro-tags');

  // Nombre obra
  const nombreEl = document.getElementById('intro-nombre');
  if (nombreEl) {
    nombreEl.textContent = item.obra.nombre;
    nombreEl.onclick = (e) => { e.stopPropagation(); enterBrowser(item.obra.id); };
  }

  // 8 filtros A en orden fijo + 4 filtros B de la imagen
  const seen = new Set();
  const tags = [];
  const pushTag = (k, v, max) => {
    if (v && v !== '—' && v !== 'Sin datos' && !seen.has(v) && tags.length < (max||12)) {
      seen.add(v); tags.push({ k, v });
    }
  };

  // 8 FILTROS A en orden establecido, siempre con texto (fallback explícito)
  const fallback = (v, fb) => (v && v !== '—' && v !== 'Sin datos' && v !== 'null') ? v : fb;
  const tagsA = [
    ...getAutores(item.obra).map(a => ({ k: 'autor', v: fallback(a, 'Sin datos') })),
    { k: 'uso',        v: fallback(item.obra.uso,        'Sin datos') },
    { k: 'pais',       v: fallback(item.obra.pais,       'Sin datos') },
    { k: 'ciudad',     v: fallback(item.obra.ciudad,     'Sin datos') },
    { k: 'decada',     v: fallback(item.obra.decada,     'Sin datos') },
    { k: 'anio',       v: fallback(item.obra.anio ? String(item.obra.anio) : null, 'Sin datos') },
    ...getFotografos(item.obra).filter(f=>f&&f!=='Sin crédito').map(f => ({ k: 'fotografo', v: f })),
    { k: 'complejidad',v: fallback(item.obra.complejidad,'Sin datos') },
  ];
  tagsA.forEach(t => { seen.add(t.v); tags.push(t); });

  // 4 FILTROS B de la imagen actual (slots 9-12)
  const bTags = [];
  const pushB = (k, v) => {
    if (v && v !== '—' && !seen.has(v) && bTags.length < 4) {
      seen.add(v); bTags.push({ k, v });
    }
  };
  // Prioridad 1: tags de la imagen actual
  elemVals(item.img,'tipoespacial').forEach(v => pushB('tipoespacial', v));
  elemVals(item.img,'material').forEach(v => pushB('material', v));
  elemVals(item.img,'componente').forEach(v => pushB('componente', v));
  // Prioridad 2: otros tags de la misma obra (no de otras)
  if (bTags.length < 4) {
    item.obra.imagenes.forEach(img => {
      elemVals(img,'tipoespacial').forEach(v => pushB('tipoespacial', v));
      elemVals(img,'material').forEach(v => pushB('material', v));
      elemVals(img,'componente').forEach(v => pushB('componente', v));
    });
  }
  // Fallback semántico: "Sin datos" — nunca vacío pero sin inventar
  const bFallbacks = ['Sin datos','Sin datos','Sin datos','Sin datos'];
  while (bTags.length < 4) bTags.push({ k: null, v: bFallbacks[bTags.length] });
  const allTags = tags.concat(bTags.slice(0, 4));

  // Crear tags la primera vez, luego solo actualizar texto (sin movimiento)
  const existing = tagsDiv.querySelectorAll('.intro-tag');
  if (existing.length !== 12) {
    tagsDiv.innerHTML = '';
    for (let i = 0; i < 12; i++) {
      const el = document.createElement('div');
      el.className = 'intro-tag';
      tagsDiv.appendChild(el);
    }
  }
  const tagEls = tagsDiv.querySelectorAll('.intro-tag');
  allTags.slice(0, 12).forEach((t, i) => {
    const el = tagEls[i];
    el.textContent = t ? t.v : '';
    el.className = 'intro-tag' + (t ? ' intro-tag-link' : ' intro-tag-empty');
    el.onclick = null;
    el.onmouseenter = null;
    el.onmouseleave = null;
    if (t) {
      el.onclick = (e) => {
        e.stopPropagation();
        AF[t.k] = [t.v];
        updateActiveCount(t.k);
        const ft = document.querySelector(`.tag[data-k="${t.k}"][data-v="${t.v}"]`);
        if (ft) ft.classList.add('active');
        enterBrowser(null);
      };
      el.onmouseenter = () => showIntroSearch(el, t);
      el.onmouseleave = (e) => {
        const popup = document.getElementById('intro-search-popup');
        if (!popup.contains(e.relatedTarget)) hideIntroSearch();
      };
    }
  });

  tagsDiv.dataset.obraId = item.obra.id;
}

let introSearchTag = null;
let introSearchActive = 0; // índice sugerencia activa

function getFilterValues(k) {
  // Obtener todos los valores únicos del filtro k de OBRAS
  const vals = new Set();
  OBRAS.forEach(o => {
    if (k === 'autor') vals.add(o.autor);
    else if (k === 'estado') vals.add(o.estado);
    else if (k === 'pais') vals.add(o.pais);
    else if (k === 'ciudad') vals.add(o.ciudad);
    else if (k === 'decada') vals.add(o.decada);
    else if (k === 'anio') vals.add(String(o.anio));
    else if (k === 'fotografo') vals.add(o.fotografo);
    else if (k === 'complejidad') vals.add(o.complejidad);
    else o.imagenes.forEach(img => {
      elemVals(img,'material').forEach(v => vals.add(v));
      elemVals(img,'componente').forEach(v => vals.add(v));
      elemVals(img,'tipoespacial').forEach(v => vals.add(v));
      (img.tipografica||[]).forEach(v => vals.add(v));
    });
  });
  return [...vals].filter(v => v && v !== '—' && v !== 'Sin datos' && v !== 'null');
}

function renderSuggestions(t, q) {
  const sugsDiv = document.getElementById('intro-search-suggestions');
  sugsDiv.innerHTML = '';
  introSearchActive = 0;
  const all = getFilterValues(t.k);
  const filtered = q
    ? all.filter(v => v.toLowerCase().includes(q.toLowerCase()))
    : all.filter(v => v.toLowerCase().startsWith(t.v[0].toLowerCase())).slice(0, 8);
  if (!filtered.length) return;
  filtered.slice(0, 10).forEach((v, i) => {
    const d = document.createElement('div');
    d.className = 'intro-search-sug' + (i === 0 ? ' active' : '');
    d.textContent = v;
    d.onmousedown = (e) => {
      e.preventDefault();
      selectIntroSearch(t, v);
    };
    sugsDiv.appendChild(d);
  });
}

function selectIntroSearch(t, v) {
  AF[t.k] = [v];
  updateActiveCount(t.k);
  const ft = document.querySelector(`.tag[data-k="${t.k}"][data-v="${v}"]`);
  if (ft) ft.classList.add('active');
  hideIntroSearch();
  enterBrowser(null);
}

function showIntroSearch(el, t) {
  introSearchTag = t;
  const popup = document.getElementById('intro-search-popup');
  const inp = document.getElementById('intro-search-inp');
  const rect = el.getBoundingClientRect();
  popup.style.display = 'block';
  popup.style.left = rect.left + 'px';
  popup.style.top = (rect.bottom + 2) + 'px';
  inp.value = '';
  inp.placeholder = t.v;
  setTimeout(() => inp.focus(), 50);
  document.getElementById('intro-search-suggestions').innerHTML = '';
  inp.oninput = () => {
    const q = inp.value.trim();
    if (q.length === 0) {
      document.getElementById('intro-search-suggestions').innerHTML = '';
    } else {
      renderSuggestions(t, q);
    }
  };
  inp.onkeydown = (e) => {
    const sugs = document.querySelectorAll('.intro-search-sug');
    if (e.key === 'ArrowDown') {
      introSearchActive = Math.min(introSearchActive + 1, sugs.length - 1);
      sugs.forEach((s, i) => s.classList.toggle('active', i === introSearchActive));
      e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      introSearchActive = Math.max(introSearchActive - 1, 0);
      sugs.forEach((s, i) => s.classList.toggle('active', i === introSearchActive));
      e.preventDefault();
    } else if (e.key === 'Enter') {
      const activeSug = document.querySelector('.intro-search-sug.active');
      if (activeSug) selectIntroSearch(t, activeSug.textContent);
      else if (inp.value.trim()) selectIntroSearch(t, inp.value.trim());
      else selectIntroSearch(t, t.v);
    } else if (e.key === 'Escape') {
      hideIntroSearch();
    }
  };
}
function hideIntroSearch() {
  document.getElementById('intro-search-popup').style.display = 'none';
  document.getElementById('intro-search-inp').value = '';
}

function enterBrowser(obraId) {
  clearInterval(introTimer);
  document.getElementById('intro-page').classList.remove('active');
  const hdr = document.getElementById('site-header');
  document.getElementById('main-content').style.paddingTop = (hdr.offsetHeight + 8) + 'px';
  if (obraId) {
    renderObra(obraId);
  } else {
    renderHome();
  }
}

function initIntro() {
  // Si hay parámetros en la URL, ir directo al buscador
  if (window.location.search) { enterBrowser(null); return; }
  if (typeof OBRAS === 'undefined' || !OBRAS || !OBRAS.length) { enterBrowser(); return; }

  buildIntroPool(() => {
    if (!introPool.length) { enterBrowser(); return; }
    introShowNext();
    introTimer = setInterval(introShowNext, 4000);
  });
}

function shareFilters() {
  const params = new URLSearchParams();
  Object.entries(AF).forEach(([k, vals]) => {
    if (vals.length) params.set(k, vals.join('|'));
  });
  if (currentObraId) params.set('obra', currentObraId);
  const url = window.location.origin + window.location.pathname + (params.toString() ? '?' + params.toString() : '');
  const btn = document.getElementById('share-btn');
  const orig = btn.textContent;
  // Intentar clipboard, fallback a prompt
  try {
    navigator.clipboard.writeText(url).then(() => {
      btn.textContent = '✓';
      setTimeout(() => btn.textContent = orig, 2000);
    }).catch(() => {
      prompt('Copiá este link:', url);
    });
  } catch(e) {
    prompt('Copiá este link:', url);
  }
}

function loadFiltersFromURL() {
  const params = new URLSearchParams(window.location.search);
  params.forEach((val, key) => {
    if (key === 'obra') return;
    if (AF.hasOwnProperty(key)) {
      AF[key] = val.split('|').filter(Boolean);
    }
  });
  // Activar visualmente los tags en la UI
  Object.entries(AF).forEach(([key, vals]) => {
    vals.forEach(v => {
      const ft = document.querySelector(`.tag[data-k="${key}"][data-v="${v}"]`);
      if (ft) ft.classList.add('active');
      updateActiveCount(key);
    });
  });
  const obra = params.get('obra');
  if (obra) { renderObra(obra); return; }
  renderHome();
}

function goHome() {
  currentObraId = null;
  Object.keys(AF).forEach(k => AF[k] = []);
  document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
  Object.keys(AF).forEach(k => updateActiveCount(k));
  closeAllDropdowns();
  document.getElementById('page-title-bar').style.display = 'none';
  document.getElementById('intro-page').classList.remove('active');
  clearInterval(introTimer);
  document.title = 'MAB - Modern Architecture Browser';
  renderHome();
}

function goIntro() {
  currentObraId = null;
  Object.keys(AF).forEach(k => AF[k] = []);
  document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
  Object.keys(AF).forEach(k => updateActiveCount(k));
  closeAllDropdowns();
  document.getElementById('page-title-bar').style.display = 'none';
  document.title = 'MAB - Modern Architecture Browser';
  clearInterval(introTimer);
  document.getElementById('intro-img-el').src = '';
  document.getElementById('intro-page').classList.add('active');
  buildIntroPool(() => {
    if (!introPool.length) { enterBrowser(); return; }
    introShowNext();
    introTimer = setInterval(introShowNext, 4000);
  });
}

// ══════════════════════════════════════════
//  LIGHTBOX
// ══════════════════════════════════════════
const VIDEO_EXTS = /\.(mp4|webm|mov|avi|mkv|ogv|m4v)$/i;
function lbShow(item) {
  const src = typeof item === 'string' ? item : item.src;
  const imgEl = document.getElementById('lb-img');
  const vid = document.getElementById('lb-video');
  if (VIDEO_EXTS.test(src)) {
    imgEl.style.display = 'none'; vid.style.display = 'block';
    vid.src = src; vid.play();
  } else {
    vid.style.display = 'none'; vid.pause(); vid.src = '';
    imgEl.style.display = 'block'; imgEl.src = src;
  }
  // Render sidebar tags
  const sidebar = document.getElementById('lb-tags-content');
  if (!sidebar || typeof item === 'string') return;
  sidebar.innerHTML = '';

  const elementos = item.elementos || [];
  const tipografica = item.tipografica || [];
  const extra = item.extra || [];
  const obra = item.obra || {};

  function makeTag(label, k, v) {
    const t = document.createElement('span');
    t.className = 'lb-tag';
    t.textContent = label;
    // Check if active
    if (k && AF[k] && AF[k].includes(v)) t.classList.add('active');
    if (k && v) {
      t.onclick = (e) => {
        e.stopPropagation();
        lbPopupOpen(k, v);
      };
      t.dataset.k = k; t.dataset.v = v;
    }
    return t;
  }

  function addGroup(label, tags) {
    const g = document.createElement('div');
    g.className = 'lb-tag-group';
    const lbl = document.createElement('div');
    lbl.className = 'lb-tag-group-label';
    lbl.textContent = label;
    g.appendChild(lbl);
    tags.forEach(([l,k,v]) => g.appendChild(makeTag(l,k,v)));
    sidebar.appendChild(g);
  }

  // Lista plana única — máximo 30 tags
  const autores = obra.autor ? (Array.isArray(obra.autor) ? obra.autor : [obra.autor]) : [];
  const fotografos = obra.fotografo ? (Array.isArray(obra.fotografo) ? obra.fotografo : [obra.fotografo]) : [];
  const materiales = [...new Set(elementos.map(el => el.material).filter(Boolean))];
  const componentes = [...new Set(elementos.map(el => el.componente).filter(Boolean))];
  const espacios = [...new Set(elementos.map(el => el.tipoespacial).filter(Boolean))];

  const allTags = [
    ...autores.map(v => [v,'autor',v]),
    obra.uso ? [obra.uso,'uso',obra.uso] : null,
    obra.pais ? [obra.pais,'pais',obra.pais] : null,
    obra.ciudad ? [obra.ciudad,'ciudad',obra.ciudad] : null,
    obra.decada ? [obra.decada,'decada',obra.decada] : null,
    obra.anio ? [String(obra.anio),'anio',String(obra.anio)] : null,
    ...fotografos.filter(f=>f&&f!=='Sin crédito').map(v => [v,'fotografo',v]),
    obra.complejidad ? [obra.complejidad,'complejidad',obra.complejidad] : null,
    ...materiales.map(v => [v,'material',v]),
    ...componentes.map(v => [v,'componente',v]),
    ...tipografica.map(v => [v,'tipografica',v]),
    ...espacios.map(v => [v,'tipoespacial',v]),
  ].filter(Boolean).slice(0, 30);

  // Un solo grupo para que display:contents funcione
  const g = document.createElement('div');
  g.className = 'lb-tag-group';
  allTags.forEach(([l,k,v]) => g.appendChild(makeTag(l,k,v)));
  sidebar.appendChild(g);
}
function lbOpen(idx) {
  lbIdx = idx;
  lbShow(lbImages[lbIdx] || lbImages[0]);
  document.getElementById('lightbox').classList.add('open');
}
function lbNext() { lbIdx = (lbIdx+1) % lbImages.length; lbShow(lbImages[lbIdx]); }
function lbPrev() { lbIdx = (lbIdx-1+lbImages.length) % lbImages.length; lbShow(lbImages[lbIdx]); }
function lbClose(e) { e.stopPropagation(); document.getElementById('lightbox').classList.remove('open'); const vid = document.getElementById('lb-video'); vid.pause(); vid.src=''; }

document.addEventListener('keydown', e => {
  const popup = document.getElementById('lb-popup');
  if (popup.classList.contains('open')) {
    if (e.key==='Escape') lbPopupClose();
    return;
  }
  const lb = document.getElementById('lightbox');
  if (!lb.classList.contains('open')) return;
  if (e.key==='Escape') lb.classList.remove('open');
  if (e.key==='ArrowRight'||e.key==='ArrowDown') lbNext();
  if (e.key==='ArrowLeft'||e.key==='ArrowUp') { lbPrev(); }
});

function lbPopupOpen(k, v) {
  // Collect all matching images
  const results = [];
  OBRAS.forEach(obra => {
    obra.imagenes.forEach(img => {
      let match = false;
      if (k === 'material') match = (img.elementos||[]).some(el => el.material === v);
      else if (k === 'componente') match = (img.elementos||[]).some(el => el.componente === v);
      else if (k === 'tipoespacial') match = (img.elementos||[]).some(el => el.tipoespacial === v);
      else if (k === 'tipografica') match = (img.tipografica||[]).includes(v);
      else if (k === 'autor') match = getAutores(obra).includes(v);
      else if (k === 'uso') match = obra.uso === v;
      else if (k === 'pais') match = obra.pais === v;
      else if (k === 'ciudad') match = obra.ciudad === v;
      else if (k === 'decada') match = obra.decada === v;
      else if (k === 'anio') match = String(obra.anio) === v;
      else if (k === 'fotografo') match = getFotografos(obra).includes(v);
      else if (k === 'complejidad') match = obra.complejidad === v;
      if (match) results.push({ img, obra });
    });
  });

  const popup = document.getElementById('lb-popup');
  const title = document.getElementById('lb-popup-title');
  const gallery = document.getElementById('lb-popup-gallery');

  title.textContent = v + ' — ' + results.length + ' imágenes';
  gallery.innerHTML = '';

  results.forEach(({ img, obra }) => {
    const cell = mkCell(img.src, '', () => {
      document.getElementById('lb-popup').classList.remove('open');
      document.getElementById('lightbox').classList.remove('open');
      renderObra(obra.id);
    });
    // Tags B de la imagen
    const tagsB = [
      ...img.tipografica.map(v => ({k:'tipografica',v})),
      ...elemVals(img,'tipoespacial').map(v => ({k:'tipoespacial',v})),
      ...elemVals(img,'material').map(v => ({k:'material',v})),
      ...elemVals(img,'componente').map(v => ({k:'componente',v}))
    ].filter(x => x.v);
    const tagsA = [
      ...getAutores(obra).map(a=>({k:'autor',v:a})),
      {k:'uso',v:obra.uso},{k:'pais',v:obra.pais},
      {k:'ciudad',v:obra.ciudad},{k:'decada',v:obra.decada},{k:'anio',v:String(obra.anio)},
    ].filter(x=>x.v&&x.v!=='—');
    const combined = [...tagsB];
    for (const a of tagsA) { if (combined.length >= 8) break; combined.push(a); }
    cell.appendChild(mkTagsDiv8(combined));
    gallery.appendChild(cell);
  });

  popup.classList.add('open');
}

function lbPopupClose() {
  document.getElementById('lb-popup').classList.remove('open');
}

window.addEventListener('DOMContentLoaded', () => {
  initIntro();
  buildTags();
  loadFiltersFromURL();

  const obs = new ResizeObserver(() => {
    const hdr = document.getElementById('site-header');
    document.getElementById('main-content').style.paddingTop = (hdr.offsetHeight + 8) + 'px';
  });
  obs.observe(document.getElementById('site-header'));

  document.addEventListener('click', e => {
    if (!e.target.closest('.filter-group') && !e.target.closest('#estado-btn-group')) closeAllDropdowns();
  });
});

async function exportPDF() {
  const images = lbImages || [];
  if (!images.length) { alert('No hay imágenes en la selección actual.'); return; }

  const filtroActivo = Object.entries(AF).filter(([k,v]) => v && v.length).map(([k,v]) => v.join(', ')).join(' · ') || 'Todas las obras';

  let pagesHtml = '';
  images.forEach(({ src, obra }) => {
    const autor = obra ? (Array.isArray(obra.autor) ? obra.autor.join(' + ') : (obra.autor || '')) : '';
    const nombre = obra ? (obra.nombre || '') : '';
    const meta = obra ? [obra.ciudad, obra.pais, obra.anio].filter(Boolean).join('  ·  ') : '';
    pagesHtml += `
      <div class="page">
        <div class="img-wrap"><img src="${src}" /></div>
        <div class="caption">
          <span class="autor-nombre"><b>${autor}</b>${autor && nombre ? '  —  ' : ''}${nombre}</span>
          <span class="meta">${meta}</span>
          <span class="brand">MAB — Modern Architecture Browser</span>
        </div>
      </div>`;
  });

  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8">
  <title>MAB · ${filtroActivo}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: white; font-family: helvetica, arial, sans-serif; }
    .page {
      width: 210mm; height: 297mm;
      padding: 12mm;
      display: flex; flex-direction: column;
      page-break-after: always;
      position: relative;
    }
    .img-wrap {
      flex: 1;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    .img-wrap img {
      max-width: 100%; max-height: 100%;
      object-fit: contain;
      display: block;
    }
    .caption {
      height: 14mm;
      display: flex; align-items: flex-end; justify-content: space-between;
      padding-top: 4mm;
      border-top: 0.3px solid #ddd;
      margin-top: 3mm;
    }
    .autor-nombre { font-size: 8pt; color: #000; flex: 1; }
    .meta { font-size: 7pt; color: #888; margin: 0 8mm; white-space: nowrap; }
    .brand { font-size: 7pt; color: #aaa; white-space: nowrap; }
    @media print {
      body { margin: 0; }
      .page { margin: 0; padding: 12mm; }
    }
  </style>
  </head><body>${pagesHtml}</body></html>`);
  win.document.close();
  win.onload = () => {
    const imgs = win.document.querySelectorAll('img');
    let loaded = 0;
    const total = imgs.length;
    if (!total) { win.print(); return; }
    imgs.forEach(img => {
      if (img.complete) { loaded++; if (loaded === total) win.print(); }
      else {
        img.onload = img.onerror = () => { loaded++; if (loaded === total) win.print(); };
      }
    });
  };
}
</body>
</html>
